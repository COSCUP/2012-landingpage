(function(k){Array.prototype.some||(Array.prototype.some=function(e){for(var a=Object(this),c=a.length>>>0,h=0;h<c;h++)if(h in a&&e.call(null,a[h],h,a))return!0;return!1});Array.prototype.shuffle=function(){for(var e,a,c=this.length;c;e=parseInt(Math.random()*c),a=this[--c],this[c]=this[e],this[e]=a);return this};k.imageCloudSupported=!0;k.fn.imageCloud=function(e){if(!k.imageCloudSupported)return this;var a={gridSize:8,ellipticity:1,query:'select * from flickr.photos.search(0,150) where group_id="1502528@N22" and sort="interestingness-desc"',
flickrSize:"s",photos:false,photoListType:"flickr",wait:50,beforeImageLoad:function(a,b,f){a.css("opacity",Math.pow(b/f,2)).hide()},imageLoad:function(a){a.fadeIn(200)},weight:function(a,b,f){a=5.5*f/43200/b*Math.pow((b-a)/b,2);return a>0.1?a:0},shuffle:true};e&&k.extend(a,e);var c,h,j,o,p,e={flickr:function(i){if(localStorage){var b=localStorage.getItem("ImageCloud:flickr:"+a.query),f=parseInt(localStorage.getItem("ImageCloud:flickr:"+a.query+":timestamp"));if(b&&Date.now()-f<864E5){i(JSON.parse(b));
return}}k.getJSON("http://query.yahooapis.com/v1/public/yql?q="+encodeURIComponent(a.query+' and extras="url_'+a.flickrSize+'"')+"&format=json&diagnostics=true&callback=?",function(b){if(!b.query.results||!b.query.results.photo)i(false);else{if(localStorage){localStorage.setItem("ImageCloud:flickr:"+a.query,JSON.stringify(b.query.results.photo));localStorage.setItem("ImageCloud:flickr:"+a.query+":timestamp",Date.now().toString())}i(b.query.results.photo)}})}},q={flickr:function(i){return{width:i["width_"+
a.flickrSize],height:i["height_"+a.flickrSize],photo_url:i["url_"+a.flickrSize],link_url:"http://www.flickr.com/photos/"+i.owner+"/"+i.id,title:i.title}}},r=function(a,b,f,d){if(a<0||b<0||a+f>c||b+d>h)return false;for(var g;f--;)for(g=d;g--;)if(!j[a+f][b+g])return false;return true},s=function(a,b,f,d){for(var g;f--;)for(g=d;g--;)j[a+f][b+g]=false},t=function(i,b,f){var d=a.weight(f,o,p),g=Math.ceil(b.width*d/a.gridSize),e=Math.ceil(b.height/b.width*g);if(g===0||e===0)return false;var j=Math.floor(Math.sqrt(c*
c+h*h)/a.gridSize)*a.gridSize,d=c+h,l,m,n;for(l=j;l=l-a.gridSize;){m=d;for(n=[];m--;)n.push([Math.floor(c/2+(j-l)*Math.cos(m/d*2*Math.PI)-g/2),Math.floor(h/2+(j-l)*a.ellipticity*Math.sin(m/d*2*Math.PI)-e/2)]);if(n.shuffle().some(function(d){if(r(d[0],d[1],g,e)){var c=k("<img />");c.css({width:(g*a.gridSize).toString(10)+"px",height:(e*a.gridSize).toString(10)+"px",left:(d[0]*a.gridSize).toString(10)+"px",top:(d[1]*a.gridSize).toString(10)+"px"});a.beforeImageLoad(c,l,j,f);c[0].onload=function(){a.imageLoad(c,
l,j,f)};var h=k('<a href="'+b.link_url+'" target="_blank" />').append(c);h.attr("title",b.title);i.append(h);c[0].src=b.photo_url;s(d[0],d[1],g,e);return true}return false}))return true}return false};if(e[a.photoListType]&&!a.photos&&a.query){var u=this;e[a.photoListType](function(c){if(c){a.photos=c;u.imageCloud(a)}});return this}q[a.photoListType]&&k.each(a.photos,function(c,b){a.photos[c]=q[a.photoListType](b)});if(a.shuffle)a.photos=a.photos.shuffle();return this.each(function(){c=Math.floor(this.offsetWidth/
a.gridSize);h=Math.floor(this.offsetHeight/a.gridSize);j=[];p=this.offsetWidth*this.offsetHeight;o=a.photos.length;for(var e=k(this),b=c,f;b--;){j[b]=[];for(f=h;f--;)j[b][f]=true}e.empty();clearTimeout(e.data("imageCloud-timer"));var d=0,g=setInterval(function(){if(d>=a.photos.length)clearTimeout(g);else{t(e,a.photos[d],d);d++}},a.wait);k(this).data("wordCloud-timer",g)})}})(jQuery);

